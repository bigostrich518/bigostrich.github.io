import React, { useState, useEffect, useMemo } from 'react';
import { AlertTriangle, FileText, Search, Tag, XCircle, Info, Loader2 } from 'lucide-react';
import ReactMarkdown from 'react-markdown';
// remarkGfm will be dynamically imported

// --- Main Application Component ---
export default function App() {
    // Application state
    const [reportsMetadata, setReportsMetadata] = useState([]); // Stores the initial list from reports.json
    const [selectedReport, setSelectedReport] = useState(null); // Holds metadata of selected report
    const [selectedReportContent, setSelectedReportContent] = useState(''); // Holds fetched MD content
    const [isReportContentLoading, setIsReportContentLoading] = useState(false);
    const [isLoading, setIsLoading] = useState(true); // Initial load of metadata
    const [error, setError] = useState(null); 
    
    // Search and Filter state
    const [searchTerm, setSearchTerm] = useState('');
    const [activeFilters, setActiveFilters] = useState({ tags: [] });
    
    // State for dynamically loaded remark-gfm plugin
    const [remarkGfmPlugin, setRemarkGfmPlugin] = useState(null);

    // Dynamically import remark-gfm
    useEffect(() => {
        import('https://esm.sh/remark-gfm')
            .then(module => {
                setRemarkGfmPlugin(() => module.default); 
            })
            .catch(err => {
                console.error("Failed to load remark-gfm:", err);
                // It's okay to proceed without it, Markdown will still render.
            });
    }, []);

    // Load reports metadata from JSON file on initial mount
    useEffect(() => {
        setIsLoading(true);
        // Use a direct relative path for fetching reports.json
        // This assumes 'data/reports.json' is accessible relative to the HTML file hosting this React app.
        // For your structure (personalsite/data/reports.json and personalsite/reportmanager.html), this is 'data/reports.json'.
        fetch('data/reports.json') 
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Failed to load 'data/reports.json'. Ensure the file exists in your public/data/ folder or equivalent accessible path.`);
                }
                return response.json();
            })
            .then(data => {
                const reportsWithDates = data.map(report => ({
                    ...report,
                    createdAt: report.createdAt ? new Date(report.createdAt) : null,
                }));
                reportsWithDates.sort((a, b) => (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0));
                setReportsMetadata(reportsWithDates);
                setError(null);
            })
            .catch(e => {
                console.error("Error loading reports metadata from JSON:", e);
                setError(`Could not load reports metadata: ${e.message}. Check the path and file format. Ensure the app is served via HTTP/HTTPS, not file:/// protocol, and that the execution environment can resolve relative paths for fetch.`);
                setReportsMetadata([]);
            })
            .finally(() => {
                setIsLoading(false);
            });
    }, []);

    // Fetch content when a report is selected
    useEffect(() => {
        if (selectedReport && selectedReport.contentPath) {
            setIsReportContentLoading(true);
            setSelectedReportContent(''); // Clear previous content
            
            // Use the contentPath directly. It should be relative to the HTML file hosting the React app.
            // e.g., "data/report-content/your-file.md"
            const contentPath = selectedReport.contentPath; 

            fetch(contentPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - Failed to load content from '${contentPath}'. Ensure the file exists at this path relative to your HTML file.`);
                    }
                    return response.text();
                })
                .then(markdownContent => {
                    setSelectedReportContent(markdownContent);
                })
                .catch(e => {
                    console.error(`Error fetching report content from ${contentPath}:`, e);
                    setSelectedReportContent(`Failed to load report content: ${e.message}. Check the path: ${contentPath}`);
                })
                .finally(() => {
                    setIsReportContentLoading(false);
                });
        } else {
            setSelectedReportContent(''); // Clear content if no report selected or no contentPath
        }
    }, [selectedReport]);


    const filteredReportsMetadata = useMemo(() => {
        // Search now applies only to metadata (title, description, tags)
        return reportsMetadata.filter(report => {
            const searchLower = searchTerm.toLowerCase();
            const matchesSearch = (
                report.title.toLowerCase().includes(searchLower) ||
                (report.description && report.description.toLowerCase().includes(searchLower)) ||
                (report.tags && report.tags.some(tag => tag.toLowerCase().includes(searchLower)))
            );
            const matchesTags = activeFilters.tags.length === 0 || 
                                (report.tags && report.tags.some(tag => activeFilters.tags.map(ft => ft.toLowerCase()).includes(tag.toLowerCase())));
            return matchesSearch && matchesTags;
        });
    }, [reportsMetadata, searchTerm, activeFilters.tags]);

    const allTags = useMemo(() => {
        const tagSet = new Set();
        reportsMetadata.forEach(report => {
            if(report.tags) report.tags.forEach(tag => tagSet.add(tag))
        });
        return Array.from(tagSet).sort();
    }, [reportsMetadata]);

    const toggleTagFilter = (tag) => {
        setActiveFilters(prev => {
            const newTags = prev.tags.includes(tag) ? prev.tags.filter(t => t !== tag) : [...prev.tags, tag];
            return { ...prev, tags: newTags };
        });
    };

    const handleSelectReport = (reportMetadata) => {
        setSelectedReport(reportMetadata);
    };

    const highlightText = (text, highlight) => {
        if (!text || !highlight || !highlight.trim()) {
            return text;
        }
        try {
            // Escape special characters in highlight term for regex
            const escapedHighlight = highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedHighlight})`, 'gi');
            const parts = String(text).split(regex);
            return (
                <>
                    {parts.map((part, i) => 
                        regex.test(part) && part.toLowerCase() === highlight.toLowerCase() ? <mark key={i} className="bg-yellow-300 dark:bg-yellow-500 px-0.5 rounded">{part}</mark> : part
                    )}
                </>
            );
        } catch (e) {
            console.error("Error in highlightText:", e);
            return text; 
        }
    };
    
    const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString();
    };
    const formatDateTime = (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return `${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
    };
    

    if (isLoading) { 
        return (
            <div className="flex items-center justify-center min-h-screen bg-slate-100 dark:bg-slate-900 text-slate-700 dark:text-slate-300 p-4">
                <Loader2 className="animate-spin h-12 w-12 text-sky-600" />
                <span className="ml-4 text-xl">Loading Reports Index...</span>
            </div>
        );
    }
    
    if (error && reportsMetadata.length === 0) { 
         return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-red-50 dark:bg-red-900 p-4 text-red-700 dark:text-red-200">
                <AlertTriangle className="h-16 w-16 text-red-500 dark:text-red-400 mb-4" />
                <h2 className="text-2xl font-semibold mb-2">Failed to Load Reports Index</h2>
                <p className="text-center max-w-md">{error}</p>
                <p className="text-xs mt-2">Please ensure `public/data/reports.json` (and content files) exist, are correctly formatted, and accessible at the expected paths. If running locally, try serving the project with a simple HTTP server.</p>
            </div>
        );
    }

    return (
        <div className="flex flex-col md:flex-row min-h-screen bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans">
            {/* --- Left Sidebar: Controls --- */}
            <aside className={`md:relative md:translate-x-0 md:w-1/3 lg:w-1/4 border-r border-slate-300 dark:border-slate-700 flex flex-col space-y-6 overflow-y-auto p-4`}>
                <h1 className="text-2xl font-bold text-sky-700 dark:text-sky-500">Report Viewer</h1>
                
                <div className="relative">
                    <input 
                        type="text" 
                        placeholder="Search titles, descriptions, tags..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        className="w-full p-2 pl-10 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100"
                    />
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-slate-400 dark:text-slate-500" />
                </div>

                {allTags.length > 0 && (
                    <div>
                        <h3 className="text-lg font-semibold mb-2 text-slate-700 dark:text-slate-300">Filter by Tags</h3>
                        <div className="flex flex-wrap gap-2">
                            {allTags.map(tag => (
                                <button 
                                    key={tag} 
                                    onClick={() => toggleTagFilter(tag)}
                                    className={`px-3 py-1 text-sm rounded-full border ${activeFilters.tags.includes(tag) ? 'bg-sky-600 text-white border-sky-600' : 'bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 border-slate-300 dark:border-slate-600 hover:bg-sky-100 dark:hover:bg-sky-800'}`}
                                >
                                    {tag}
                                </button>
                            ))}
                        </div>
                        {activeFilters.tags.length > 0 && (
                            <button onClick={() => setActiveFilters({ tags: [] })} className="mt-2 text-xs text-sky-600 dark:text-sky-400 hover:underline">Clear tag filters</button>
                        )}
                    </div>
                )}
                 <div className="mt-auto pt-4 border-t border-slate-300 dark:border-slate-700">
                    <p className="text-xs text-slate-500 dark:text-slate-400">Reports index loaded from project data.</p>
                     {error && reportsMetadata.length > 0 && <p className="text-xs text-yellow-600 dark:text-yellow-400 mt-1">Note: There was an issue loading the main index: {error}</p>}
                 </div>
            </aside>

            {/* --- Main Content Area: Report List / Report View --- */}
            <main className="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
                {!selectedReport && (
                    <>
                        {filteredReportsMetadata.length === 0 ? (
                            <div className="text-center py-10">
                                <FileText size={48} className="mx-auto text-slate-400 dark:text-slate-500 mb-4" />
                                <h3 className="text-xl font-semibold text-slate-600 dark:text-slate-300">No Reports Found</h3>
                                {reportsMetadata.length > 0 && (searchTerm || activeFilters.tags.length > 0) && <p className="text-slate-500 dark:text-slate-400">Try adjusting your search or filter criteria.</p>}
                                {reportsMetadata.length === 0 && !error && <p className="text-slate-500 dark:text-slate-400">No reports defined in the data source.</p>}
                            </div>
                        ) : (
                            <div className={`grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4`}>
                                {filteredReportsMetadata.map(report => (
                                    <div key={report.id} className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex flex-col justify-between" onClick={() => handleSelectReport(report)}>
                                        <div>
                                            <h3 className="text-lg font-semibold text-sky-700 dark:text-sky-400 mb-1 truncate" title={report.title}>{highlightText(report.title, searchTerm)}</h3>
                                            {report.description && <p className="text-sm text-slate-600 dark:text-slate-400 mb-2 line-clamp-2">{highlightText(report.description, searchTerm)}</p>}
                                            <p className="text-xs text-slate-500 dark:text-slate-500 mb-2">
                                                Date: {formatDate(report.createdAt)}
                                                {report.sourceAITool && ` | Source: ${report.sourceAITool}`}
                                            </p>
                                            {report.tags && report.tags.length > 0 && (
                                                <div className="flex flex-wrap gap-1 mb-2">
                                                    {report.tags.slice(0,3).map(tag => (
                                                        <span key={tag} className="px-2 py-0.5 text-xs bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-full">{highlightText(tag, searchTerm)}</span>
                                                    ))}
                                                    {report.tags.length > 3 && <span className="px-2 py-0.5 text-xs bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-full">+{report.tags.length - 3} more</span>}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </>
                )}
                
                {selectedReport && (
                    <div className="bg-white dark:bg-slate-800 p-4 sm:p-6 rounded-lg shadow-xl">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-2xl sm:text-3xl font-bold text-sky-800 dark:text-sky-300 mb-1">{highlightText(selectedReport.title, searchTerm)}</h2>
                                <p className="text-xs text-slate-500 dark:text-slate-400">
                                    Date: {formatDateTime(selectedReport.createdAt)}
                                </p>
                                {selectedReport.sourceAITool && <p className="text-sm text-slate-600 dark:text-slate-300 mt-1">Source AI: {selectedReport.sourceAITool}</p>}
                            </div>
                            <button onClick={() => setSelectedReport(null)} className="p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                                <XCircle className="h-6 w-6" />
                            </button>
                        </div>

                        {selectedReport.tags && selectedReport.tags.length > 0 && (
                            <div className="mb-4">
                                <h4 className="font-semibold text-slate-700 dark:text-slate-300 mb-1">Tags:</h4>
                                <div className="flex flex-wrap gap-2">
                                    {selectedReport.tags.map(tag => (
                                        <span key={tag} className="px-3 py-1 text-sm bg-sky-100 dark:bg-sky-900 text-sky-700 dark:text-sky-300 rounded-full border border-sky-300 dark:border-sky-700">{highlightText(tag, searchTerm)}</span>
                                    ))}
                                </div>
                            </div>
                        )}

                        {selectedReport.description && (
                            <div className="mb-6 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-md">
                                <h4 className="font-semibold text-slate-700 dark:text-slate-300 mb-1">Summary/Description:</h4>
                                <p className="text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap">{highlightText(selectedReport.description, searchTerm)}</p>
                            </div>
                        )}
                        
                        {isReportContentLoading && (
                             <div className="flex items-center justify-center min-h-[200px]">
                                <Loader2 className="animate-spin h-8 w-8 text-sky-600" />
                                <span className="ml-3 text-md">Loading report content...</span>
                            </div>
                        )}

                        {!isReportContentLoading && selectedReportContent && remarkGfmPlugin && (
                            <div className="prose prose-slate dark:prose-invert max-w-none prose-sm sm:prose-base">
                                 <ReactMarkdown remarkPlugins={[remarkGfmPlugin]}>
                                    {selectedReportContent}
                                </ReactMarkdown>
                            </div>
                        )}
                         {!isReportContentLoading && !selectedReportContent && selectedReport.contentPath && (
                            <p className="text-slate-500 dark:text-slate-400">Report content could not be loaded or is empty.</p>
                         )}
                         {!selectedReport.contentPath && (
                            <p className="text-slate-500 dark:text-slate-400">No content path defined for this report.</p>
                         )}
                    </div>
                )}
            </main>
        </div>
    );
}
